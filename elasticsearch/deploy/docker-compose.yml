# Elasticsearch + Milvus + MinIO 一键部署配置
#
# 使用方法:
#   docker-compose up -d          # 启动所有服务
#   docker-compose ps             # 查看服务状态
#   docker-compose down           # 停止并删除所有服务
#   docker-compose logs -f        # 查看日志
#
# 增强功能:
#   - restart: unless-stopped     # 服务异常自动重启
#   - healthcheck                 # 健康检查
#   - 数据持久化                  # Volume 存储

version: '3.8'

services:
  # Elasticsearch 搜索引擎
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.18.0
    container_name: es01
    restart: unless-stopped
    environment:
      # 单节点模式
      - discovery.type=single-node
      # 禁用安全认证 (开发环境)
      - xpack.security.enabled=false
      # JVM 内存配置
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"  # REST API 端口
      - "9300:9300"  # Java 客户端端口
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - es-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Milvus 向量数据库
  milvus:
    image: milvusdb/milvus:v2.5.10
    container_name: milvus
    restart: unless-stopped
    command: ["milvus", "run", "standalone"]
    ports:
      - "19530:19530"  # gRPC 端口
      - "9091:9091"    # REST API 端口
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - es-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9091/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - etcd
      - minio

  # etcd - Milvus 元数据存储
  etcd:
    image: quay.io/coreos/etcd:v3.5.16
    container_name: etcd
    restart: unless-stopped
    command: etcd -advertise-client-urls http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    volumes:
      - etcd-data:/etcd
    networks:
      - es-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:2379/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"  # S3 API 端口
      - "9001:9001"  # Console 端口
    volumes:
      - minio-data:/data
    environment:
      # 默认访问凭证
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    networks:
      - es-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Attu - Milvus 图形化管理工具 (可选)
  attu:
    image: zilliz/attu:v2.3.5
    container_name: attu
    restart: unless-stopped
    ports:
      - "8000:3000"
    environment:
      - MILVUS_URL=milvus:19530
    networks:
      - es-network
    depends_on:
      - milvus

volumes:
  # 数据持久化卷
  es-data:
    driver: local
  milvus-data:
    driver: local
  etcd-data:
    driver: local
  minio-data:
    driver: local

networks:
  es-network:
    driver: bridge

# 备注:
# 1. Elasticsearch 首次启动需要约 1-2 分钟初始化
# 2. 访问 http://localhost:9200 验证 ES 是否启动成功
# 3. 访问 http://localhost:9001 进入 MinIO Console
# 4. 访问 http://localhost:8000 进入 Attu 管理界面
# 5. 使用 restart: unless-stopped 确保服务异常时自动重启
